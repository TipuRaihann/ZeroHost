<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZeroHost - Your Repos</title>
  <style>
    body {
      background: #fff;
      font-family: Arial, sans-serif;
      padding: 1rem 2rem;
      max-width: 700px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    #repoList {
      margin-top: 1.5rem;
      max-height: 400px;
      overflow-y: auto;
      border-top: 1px solid #eee;
      text-align: left;
    }
    .repo {
      display: flex;
      justify-content: space-between;
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 10px 16px;
      margin: 0.5rem 0;
      align-items: center;
    }
    .repo strong {
      font-weight: 600;
      font-size: 1rem;
      word-break: break-all;
    }
    .repo button {
      background: transparent;
      border: 1.5px solid black;
      color: black;
      font-weight: 600;
      padding: 6px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .repo button:hover {
      background: black;
      color: white;
    }
    #logoutBtn {
      display: block;
      margin: 1rem auto 0;
      background: #900;
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }
    #logoutBtn:hover {
      background: #b00;
    }
  </style>
</head>
<body>
  <h1>Your GitHub Repositories</h1>
  <div id="repoList" aria-live="polite" aria-label="Repository List"></div>
  <button id="logoutBtn" aria-label="Logout">Logout</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAOnz21ibc6Y0AGhsc5k5cNrnxm2HVnP10",
      authDomain: "zero-host.firebaseapp.com",
      projectId: "zero-host",
      storageBucket: "zero-host.appspot.com",
      messagingSenderId: "528079836587",
      appId: "1:528079836587:web:098e3c18b90e6b77c66eee",
      measurementId: "G-F3DP7N7QQQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const token = localStorage.getItem("githubToken");
    const userEmail = localStorage.getItem("userEmail");
    const repoListDiv = document.getElementById("repoList");
    const logoutBtn = document.getElementById("logoutBtn");

    if (!token || !userEmail) {
      alert("No login found, redirecting to login page.");
      window.location.href = "login.html";
    }

    async function fetchRepos() {
      try {
        const res = await fetch("https://api.github.com/user/repos?per_page=100", {
          headers: { Authorization: `token ${token}` }
        });
        if (!res.ok) throw new Error(`GitHub API error: ${res.status} ${res.statusText}`);

        const repos = await res.json();

        if (!Array.isArray(repos) || repos.length === 0) {
          repoListDiv.innerHTML = "<p style='color:#888;'>No repositories found in your GitHub account.</p>";
          return;
        }

        repoListDiv.innerHTML = "";
        repos.forEach(repo => {
          const div = document.createElement("div");
          div.className = "repo";

          const repoName = document.createElement("strong");
          repoName.textContent = repo.full_name;

          const genBtn = document.createElement("button");
          genBtn.textContent = "Generate Link";

          genBtn.onclick = async () => {
            const slug = Math.random().toString(36).substring(2, 10);
            try {
              await addDoc(collection(db, "pages"), {
                slug,
                owner: repo.owner.login,
                repo: repo.name,
                user: userEmail,
                createdAt: new Date()
              });
              // Redirect to show.html with slug param
              window.location.href = `show.html?slug=${slug}`;
            } catch(e) {
              alert("Error saving link: " + e.message);
            }
          };

          div.appendChild(repoName);
          div.appendChild(genBtn);
          repoListDiv.appendChild(div);
        });

      } catch (error) {
        repoListDiv.innerHTML = `<p style="color:red;">Error fetching repos: ${error.message}</p>`;
      }
    }

    logoutBtn.onclick = () => {
      localStorage.removeItem("githubToken");
      localStorage.removeItem("userEmail");
      window.location.href = "login.html";
    };

    fetchRepos();
  </script>
</body>
</html>
